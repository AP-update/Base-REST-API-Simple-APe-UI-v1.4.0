<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> APe UI Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        h1, h2, h3, .method-get, .btn-try, .btn-execute {
            font-family: 'Space Grotesk', sans-serif;
        }
        
        #page-loader {
            position: fixed;
            inset: 0;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader-ring {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(73, 204, 144, 0.1);
            border-top: 4px solid #49cc90;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Spinner kecil untuk tombol */
        .btn-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .category-content.active {
            max-height: 5000px;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .glass-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
        }

        .api-card-get {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(73, 204, 144, 0.05);
            border: 1px solid #49cc90;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .api-card-get:hover { background: rgba(73, 204, 144, 0.1); border-color: #3eaf7c; transform: translateY(-1px); }

        .method-get {
            background-color: #49cc90;
            color: white;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            min-width: 55px;
            text-align: center;
        }

        .btn-try {
            font-size: 10px;
            font-weight: 800;
            color: #49cc90;
            padding: 4px 12px;
            border: 1px solid #49cc90;
            border-radius: 6px;
            background: white;
            transition: all 0.2s;
        }
        .api-card-get:hover .btn-try {
            background: #49cc90;
            color: white;
        }

        #toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            animation: slideIn 0.3s ease-out forwards;
            min-width: 250px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 640px) {
            .api-card-get { gap: 8px; padding: 8px; }
            .method-get { min-width: 45px; font-size: 9px; }
            .api-name { font-size: 11px !important; }
            .btn-try { padding: 3px 8px; font-size: 9px; }
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="page-loader">
        <div class="loader-ring"></div>
        <p class="text-white mt-4 font-bold tracking-[0.2em] text-[10px] animate-pulse uppercase">LOADING...</p>
    </div>

    <div id="toast-container"></div>

    <nav class="glass-nav border-b border-slate-700 p-4 sticky top-0 z-50 shadow-xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="profile-container" class="hidden">
                    <img id="owner-img" src="" alt="Owner" class="w-9 h-9 rounded-full border-2 border-[#49cc90] object-cover shadow-lg">
                </div>
                <div id="default-logo" class="w-8 h-8 bg-[#49cc90] rounded flex items-center justify-center text-white shadow-md shadow-[#49cc90]/20">
                    <i class="fa-solid fa-bolt text-sm"></i>
                </div>
                <h1 id="brand" class="text-lg font-bold text-white tracking-tight">APe UI</h1>
            </div>
            <div id="api-type-badge" class="text-[9px] text-[#49cc90] font-black border border-[#49cc90]/30 px-2 py-1 rounded uppercase tracking-tighter">Loading...</div>
        </div>
    </nav>

    <div class="bg-white/70 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-5xl mx-auto px-6 py-10">
            <h2 class="text-3xl font-extrabold text-slate-900 mb-2 tracking-tight">API Documentation</h2>
            <p id="description-header" class="text-slate-500 text-sm max-w-2xl leading-relaxed">Memuat deskripsi...</p>
            
            <div class="mt-4 flex flex-wrap items-center gap-x-6 gap-y-2">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Base URL:</span>
                    <span id="base-url-text" class="text-[11px] font-mono font-bold text-indigo-600 tracking-tight"></span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status:</span>
                    <div class="flex items-center gap-1.5">
                        <div class="w-2 h-2 bg-[#49cc90] rounded-full animate-pulse shadow-[0_0_8px_#49cc90]"></div>
                        <span class="text-[11px] font-bold text-slate-600 uppercase tracking-tight">Online</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto p-4 md:p-8">
        <div class="relative mb-8 group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-[#49cc90]">
                <i class="fa-solid fa-magnifying-glass text-xs"></i>
            </div>
            <input type="text" id="search-api" onkeyup="filterAPI()" placeholder="Cari endpoint (nama, path, atau deskripsi)..." class="w-full bg-white border border-slate-300 rounded-xl py-3.5 pl-11 pr-4 text-sm focus:border-[#49cc90] focus:ring-4 focus:ring-[#49cc90]/5 outline-none shadow-sm transition-all">
        </div>

        <div id="app-content">
            <div class="text-center py-20 text-slate-400 font-medium text-sm">
                <i class="fa-solid fa-circle-notch fa-spin mb-3 text-2xl text-[#49cc90]"></i>
                <p>Sinkronisasi data...</p>
            </div>
        </div>
    </main>

    <footer class="max-w-7xl mx-auto p-12 mt-10 border-t border-slate-200 text-center">
        <p id="settings-footer" class="text-slate-400 text-[10px] font-medium uppercase tracking-[0.2em]"></p>
    </footer>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center p-4 z-[100] backdrop-blur-sm transition-all">
        <div class="bg-white rounded-2xl w-full max-w-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh] border border-slate-200">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-[#49cc90]/5">
                <div class="flex items-center gap-3">
                    <span class="method-get">GET</span>
                    <h2 id="m-name" class="font-bold text-slate-800 text-sm md:text-base leading-tight"></h2>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-red-50 hover:text-red-500 text-slate-400 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            
            <div class="p-5 space-y-4 overflow-y-auto flex-1 custom-scroll">
                <div id="m-note-container"></div>
                
                <div class="space-y-2">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Request URL</label>
                    <div class="flex gap-1">
                        <input type="text" id="m-url" readonly class="w-full bg-slate-100 border border-slate-200 rounded-lg px-3 py-2.5 text-[10px] font-mono text-slate-600 outline-none">
                        <button id="copy-btn" onclick="copyURL()" class="bg-white text-slate-600 border border-slate-200 px-4 rounded-lg hover:bg-[#49cc90] hover:text-white hover:border-[#49cc90] transition-all flex items-center justify-center">
                            <i id="copy-icon" class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                </div>

                <div id="m-inputs" class="grid grid-cols-1 gap-4"></div>

                <div id="m-result" class="hidden space-y-2">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Server Response</label>
                    <div id="res-content"></div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-5 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider">Tutup</button>
                <button id="run-btn" class="btn-execute bg-[#49cc90] text-white px-10 py-2.5 rounded-lg text-xs font-black hover:bg-[#3eaf7c] transition-all uppercase tracking-widest shadow-lg shadow-[#49cc90]/20 flex items-center justify-center min-w-[140px]">Execute</button>
            </div>
        </div>
    </div>

    <script>
        let config = {};
        let currentPath = "", currentParams = [], currentAuth = false;

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-[#49cc90]' : 'bg-red-500';
            const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            toast.className = `toast ${colorClass} text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-3`;
            toast.innerHTML = `
                <i class="fa-solid ${iconClass}"></i>
                <span class="text-xs font-bold tracking-wide">${msg}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function start() {
            document.getElementById('base-url-text').innerText = window.location.origin;
            try {
                const res = await fetch('/api/docs-data');
                config = await res.json();
                document.getElementById('brand').innerText = config.settings.api_name || 'API ape';
                document.getElementById('api-type-badge').innerText = config.settings.api_type || 'APe UI';
                document.getElementById('description-header').innerText = config.settings.description || 'Eksplorasi layanan API kami.';
                document.getElementById('settings-footer').innerHTML = `Powered by <span class="text-[#49cc90] font-bold">${config.settings.owner}</span> | ${config.settings.footer}`;

                if (config.settings.use_profile && config.settings.owner_profile) {
                    const profileImg = document.getElementById('owner-img');
                    const profileCont = document.getElementById('profile-container');
                    const defaultLogo = document.getElementById('default-logo');

                    profileImg.src = config.settings.owner_profile;
                    profileCont.classList.remove('hidden');
                    defaultLogo.classList.add('hidden');
                }
                render();

                setTimeout(() => {
                    const loader = document.getElementById('page-loader');
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }, 1000);

            } catch (e) {
                document.getElementById('app-content').innerHTML = `<p class="text-center text-red-500 py-20 font-bold">Gagal sinkronisasi data server.</p>`;
                document.getElementById('page-loader').style.display = 'none';
            }
        }

        function updateToggleUI(categoryId, isOpen) {
            const content = document.getElementById(`content-${categoryId}`);
            const btn = document.getElementById(`btn-toggle-${categoryId}`);
            const icon = document.getElementById(`icon-${categoryId}`);
            
            if (isOpen) {
                content.classList.add('active');
                btn.innerText = 'CLOSE';
                icon.classList.replace('fa-folder', 'fa-folder-open');
                icon.parentElement.classList.add('text-[#49cc90]', 'border-[#49cc90]/30');
            } else {
                content.classList.remove('active');
                btn.innerText = 'OPEN';
                icon.classList.replace('fa-folder-open', 'fa-folder');
                icon.parentElement.classList.remove('text-[#49cc90]', 'border-[#49cc90]/30');
            }
        }

        function toggleCategory(categoryId) {
            const content = document.getElementById(`content-${categoryId}`);
            const isOpen = !content.classList.contains('active');
            updateToggleUI(categoryId, isOpen);
        }

        function render() {
            const container = document.getElementById('app-content');
            container.innerHTML = "";
            Object.keys(config.endpoints).forEach((category, idx) => {
                const categoryId = `cat-${idx}`;
                let html = `
                    <div class="mb-4 bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-200 category-wrapper" id="wrapper-${categoryId}">
                        <div onclick="toggleCategory('${categoryId}')" class="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 select-none">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 bg-slate-50 text-slate-400 rounded-xl flex items-center justify-center text-sm border border-slate-100 transition-all">
                                    <i id="icon-${categoryId}" class="fa-solid fa-folder"></i>
                                </div>
                                <div>
                                    <h2 class="text-[13px] font-extrabold text-slate-700 capitalize tracking-wide">${category}</h2>
                                    <p class="text-[9px] text-[#49cc90] font-bold uppercase">${config.endpoints[category].length} Endpoints</p>
                                </div>
                            </div>
                            <span id="btn-toggle-${categoryId}" class="text-[10px] font-extrabold text-[#64748b] border border-slate-200 px-3 py-1.5 rounded-lg bg-white shadow-sm hover:bg-slate-50 transition-all uppercase tracking-tighter">OPEN</span>
                        </div>
                        <div id="content-${categoryId}" class="category-content">
                            <div class="p-4 space-y-3 bg-slate-50/40">
                `;
                config.endpoints[category].forEach(ep => {
                    const isOnline = ep.status === 'online';
                    const statusColor = isOnline ? 'text-green-500' : (ep.status === 'maintenance' ? 'text-orange-500' : 'text-red-500');
                    const searchTerms = `${ep.name} ${ep.path} ${ep.desc}`.toLowerCase();
                    
                    html += `
                        <div class="api-card-get group cursor-pointer ${!isOnline ? 'opacity-60 grayscale-[0.5]' : ''}" 
                             onclick="${isOnline ? `openTry('${category}', '${ep.name}')` : "showToast('Endpoint sedang offline', 'error')"}" 
                             data-search="${searchTerms}">
                            <span class="method-get">GET</span>
                            <div class="flex-1 min-w-0">
                                <h3 class="api-name font-mono font-bold text-slate-800 text-[13px] truncate">
                                    ${ep.path.split('?')[0]} ${ep.auth ? '<i class="fa-solid fa-lock text-amber-500 text-[10px] ml-1"></i>' : ''}
                                </h3>
                                <div class="flex items-center gap-2">
                                    <p class="text-[10px] text-slate-400 truncate mt-0.5 font-medium">${ep.desc}</p>
                                    <span class="text-[9px] font-black uppercase ${statusColor}">${ep.status}</span>
                                </div>
                            </div>
                            <span class="btn-try">${isOnline ? 'TRY' : 'OFF'}</span>
                        </div>`;
                });
                container.innerHTML += html + `</div></div></div>`;
            });
        }

        function filterAPI() {
            const val = document.getElementById('search-api').value.toLowerCase().trim();
            const wrappers = document.querySelectorAll('.category-wrapper');
            wrappers.forEach(wrapper => {
                const categoryId = wrapper.id.replace('wrapper-', '');
                const cards = wrapper.querySelectorAll('.api-card-get');
                let hasMatch = false;
                cards.forEach(card => {
                    const searchData = card.getAttribute('data-search') || "";
                    if (searchData.includes(val)) {
                        card.style.display = "flex";
                        hasMatch = true;
                    } else {
                        card.style.display = "none";
                    }
                });
                if (val !== "" && hasMatch) {
                    wrapper.style.display = "block";
                    updateToggleUI(categoryId, true);
                } else if (val === "") {
                    wrapper.style.display = "block";
                    updateToggleUI(categoryId, false);
                } else {
                    wrapper.style.display = "none";
                }
            });
        }

        async function copyURL() {
            const urlInput = document.getElementById('m-url');
            const icon = document.getElementById('copy-icon');
            try {
                await navigator.clipboard.writeText(urlInput.value);
                icon.className = "fa-solid fa-check";
                showToast("URL Endpoint disalin!");
                setTimeout(() => icon.className = "fa-regular fa-copy", 2000);
            } catch (err) {
                showToast("Gagal menyalin URL", "error");
            }
        }

        function openTry(category, name) {
            const ep = config.endpoints[category].find(x => x.name === name);
            currentPath = ep.path.includes('?') ? ep.path.split('?')[0] : ep.path;
            currentAuth = ep.auth;
            const paramMatch = ep.path.match(/[?&]([^=&]+)=/g);
            currentParams = paramMatch ? paramMatch.map(p => p.replace(/[?&=]/g, '')) : [];
            
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('m-name').innerHTML = `
                <div class="flex flex-col">
                    <span class="text-slate-800">${ep.name}</span>
                    <span class="text-[10px] font-medium text-slate-500 normal-case italic">(${ep.desc})</span>
                </div>
            `;
            document.getElementById('m-result').classList.add('hidden');
            
            const noteContainer = document.getElementById('m-note-container');
            noteContainer.innerHTML = ep.note ? `
                <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fa-solid fa-circle-info text-blue-500 text-[10px]"></i>
                        <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest">Catatan / Note</span>
                    </div>
                    <p class="text-[11px] text-blue-700 font-medium leading-relaxed">${ep.note}</p>
                </div>` : "";

            const inputContainer = document.getElementById('m-inputs');
            inputContainer.innerHTML = `<p class="text-[10px] font-bold text-slate-500 border-b border-slate-100 pb-2 mb-2 uppercase tracking-widest">Parameters</p>`;
            
            if(ep.auth) {
                inputContainer.innerHTML += `
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-mono font-bold text-amber-600 uppercase">apikey (Wajib)</label>
                        <input type="text" id="in-apikey" oninput="updateURL()" placeholder="Masukkan apikey Anda..." class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2.5 text-xs focus:border-amber-500 outline-none transition-all">
                    </div>`;
            }

            currentParams.forEach(p => {
                inputContainer.innerHTML += `
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-mono font-bold text-slate-600 uppercase">${p}</label>
                        <input type="text" id="in-${p}" oninput="updateURL()" placeholder="Isi parameter..." class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2.5 text-xs focus:border-[#49cc90] outline-none transition-all">
                    </div>`;
            });
            updateURL();

            document.getElementById('run-btn').onclick = async () => {
                const btn = document.getElementById('run-btn');
                const resDiv = document.getElementById('res-content');
                const resContainer = document.getElementById('m-result');
                const apiKeyInput = document.getElementById('in-apikey');

                if (currentAuth && (!apiKeyInput || !apiKeyInput.value.trim())) {
                    apiKeyInput.classList.add('border-red-500', 'bg-red-50');
                    apiKeyInput.focus();
                    showToast("Harap isi API Key terlebih dahulu!", "error");
                    return;
                } else if (apiKeyInput) {
                    apiKeyInput.classList.remove('border-red-500', 'bg-red-50');
                }

                // Efek loading pada tombol dan area hasil
                btn.disabled = true;
                btn.innerHTML = `<span class="btn-spinner mr-2"></span> EXECUTING...`;
                
                resContainer.classList.remove('hidden');
                resDiv.innerHTML = `
                    <div class="w-full flex flex-col items-center justify-center py-10 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                        <div class="loader-ring !w-8 !h-8 !border-2 mb-3"></div>
                        <p class="text-[10px] font-bold text-slate-400 animate-pulse uppercase tracking-widest">Menunggu Respon Server...</p>
                    </div>
                `;
                
                try {
                    const response = await fetch(document.getElementById('m-url').value);
                    const contentType = response.headers.get("content-type");
                    
                    if (response.status === 401 || response.status === 403) {
                        showToast("API Key salah atau tidak valid!", "error");
                        if(apiKeyInput) apiKeyInput.classList.add('border-red-500');
                        throw new Error(`Akses Ditolak: API Key tidak valid (${response.status})`);
                    }

                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

                    if (contentType && contentType.includes("image")) {
                        const blob = await response.blob();
                        resDiv.innerHTML = `<div class="rounded-xl overflow-hidden shadow-lg border border-slate-200 bg-white p-2">
                            <img src="${URL.createObjectURL(blob)}" class="w-full h-auto rounded-lg">
                        </div>`;
                        showToast("Gambar berhasil dimuat!");
                    } else {
                        const data = await response.json();
                        if (data.status === false || data.error) {
                            showToast(data.message || "Gagal mendapatkan data", "error");
                        } else {
                            showToast("Data berhasil diterima!");
                        }
                        resDiv.innerHTML = `
                            <div class="w-full rounded-xl bg-[#0f172a] p-4 text-[#49cc90] shadow-inner border border-slate-800 overflow-x-auto">
                                <pre class="whitespace-pre-wrap break-all text-[10px] font-mono leading-relaxed">${JSON.stringify(data, null, 2)}</pre>
                            </div>`;
                    }
                } catch(e) { 
                    resDiv.innerHTML = `
                        <div class="w-full rounded-xl bg-red-50 p-5 text-red-600 border border-red-200 font-mono text-[10px] leading-relaxed">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-circle-xmark"></i>
                                <strong class="uppercase">Execution Error</strong>
                            </div>
                            ${e.message}
                        </div>`;
                    if (!e.message.includes("Akses Ditolak")) showToast("Gagal mengeksekusi request", "error"); 
                } finally { 
                    btn.innerHTML = "Execute"; 
                    btn.disabled = false; 
                }
            };
        }

        function updateURL() {
            let q = new URLSearchParams();
            if(currentAuth) {
                const ak = document.getElementById('in-apikey')?.value;
                if(ak) q.append('apikey', ak);
            }
            currentParams.forEach(p => {
                const val = document.getElementById('in-'+p).value;
                if(val) q.append(p, val);
            });
            document.getElementById('m-url').value = window.location.origin + currentPath + (q.toString() ? '?' + q.toString() : '');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        start();
    </script>
</body>
</html>
